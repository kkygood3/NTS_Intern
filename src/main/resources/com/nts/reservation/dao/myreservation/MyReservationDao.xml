<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nts.reservation.dao.myreservation.MyReservationDao">
	<select id="selectMyReservation" resultType="MyReservationInfo">
		SELECT
			r.id AS reservation_info_id,  
			rp.id AS reservation_info_price_id,  
			r.reservation_name,  
			r.display_info_id,  
			r.reservation_date,  
			p.description AS product_description,  
			d.place_name,  
			d.opening_hours,  
			SUM(ROUND(pp.price * (100-pp.discount_rate) * rp.count/100,0)) AS price,
			r.cancel_flag
		FROM
			reservation_info AS r  
		INNER JOIN
			display_info AS d ON r.display_info_id = d.id  
		INNER JOIN
			product AS p ON r.product_id = p.id  
		INNER JOIN
			reservation_info_price AS rp ON r.id = rp.reservation_info_id  
		INNER JOIN
			product_price AS pp ON rp.product_price_id = pp.id  
		WHERE
			r.reservation_email = #{email}
		<choose>
			<when test="type.equals('CANCEL')">
				AND r.cancel_flag = 1
			</when>
			<otherwise>
				AND r.cancel_flag = 0
				<choose>
					<when test="type.equals('CONFIRM')">
						AND NOW() &lt; r.reservation_date
					</when>
					<otherwise>
						AND NOW() &gt;= r.reservation_date
					</otherwise>
				</choose>
			</otherwise>
		</choose>
		GROUP BY
			r.id
		ORDER BY
		<choose>
			<when test="type.equals('CANCEL')">
				r.modify_date DESC
			</when>
			<when test="type.equals('CONFIRM')">
				r.reservation_date ASC
			</when>
			<otherwise>
				r.reservation_date DESC
			</otherwise>
		</choose>
		LIMIT
			#{start}, #{pagingLimit}
	</select>
	
	<select id="selectMyReservationCount" resultType="int">
		SELECT
			COUNT(r.id) AS count
		FROM
			reservation_info AS r
		WHERE
			r.reservation_email = #{email}
		<choose>
			<when test="type.equals('CANCEL')">
				AND r.cancel_flag = 1
			</when>
			<otherwise>
				AND r.cancel_flag = 0
				<choose>
					<when test="type.equals('CONFIRM')">
						AND NOW() &lt; r.reservation_date
					</when>
					<otherwise>
						AND NOW() &gt;= r.reservation_date
					</otherwise>
				</choose>
			</otherwise>
		</choose>
	</select>
	<update id="updateMyReservationCancelById">
		UPDATE 
			reservation_info AS r 
		SET 
			cancel_flag = 1,
			modify_date = NOW()
		WHERE
			r.id = #{reservationInfoId}
			AND r.reservation_email = #{email}
	</update>
</mapper>