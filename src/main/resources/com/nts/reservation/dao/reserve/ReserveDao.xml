<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http#{//mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nts.reservation.dao.reserve.ReserveDao">
	<insert id="insertReservation">
		<selectKey keyProperty="id" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
		INSERT 
			INTO
				reservation_info( 
				product_id, 
				display_info_id, 
				reservation_name, 
				reservation_tel, 
				reservation_email, 
				reservation_date, 
				cancel_flag, 
				create_date, 
				modify_date) 
			SELECT 
				p.id, 
				d.id, 
				#{name}, 
				#{telephone}, 
				#{email}, 
				#{reservationDate}, 
				0, 
				NOW(), 
				NOW() 
			FROM
				display_info AS d 
			INNER JOIN
				product AS p ON d.product_id = p.id 
			WHERE
				d.id = #{displayInfoId}
			GROUP BY
				p.id
	</insert>
	<insert id="insertReservationPrice">
		INSERT 
			INTO
				reservation_info_price( 
				reservation_info_id, 
				product_price_id, 
				count) 
			SELECT 
				#{reservationInfoId}, 
				pp.id, 
				#{count} 
			FROM
				display_info AS d 
			INNER JOIN
				product_price AS pp ON d.product_id = pp.product_id 
			WHERE
				pp.price_type_name = #{type} AND d.id = #{displayInfoId}
	</insert>
</mapper>